name: Workflow

on:
  push:
    branches:
      - feat-devsecops

jobs:
  SAST:
    runs-on: ubuntu-latest
    steps:
      - name: Set up JDK 17
        uses: actions/setup-java@v2
        with:
          java-version: "17"
          distribution: "adopt"

      - name: Checkout code
        uses: actions/checkout@v2

      - name: Validate Project on SonarCloud
        id: ValidateProjectSonar
        run: |
          set +e
          curl -f -X POST -u '${{ secrets.SONAR_TOKEN }}:' 'https://sonarcloud.io/api/projects/create' \
            -d 'name=${{ github.event.repository.name }}' \
            -d 'project=${{ github.event.repository.name }}' \
            -d 'organization=devsecops7' \
            -d 'visibility=public'
          if [ $? -ne 0 ]; then
            echo "Proyecto ya existe en SonarCloud"
          else
            echo "El Proyecto ${{ github.event.repository.name }} fue creado exitosamente en SonarCloud"
            echo "Estableciendo la rama main como rama por defecto"
            curl -X POST -u '${{ secrets.SONAR_TOKEN }}:' 'https://sonarcloud.io/api/project_branches/rename' \
              -d 'name=main' \
              -d 'projects=${{ github.event.repository.name }}'
          fi
